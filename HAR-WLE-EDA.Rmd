---
title: "Human Activity Recognition - Weight Lifting Exploratory Data Analysis"
author: "Maurício Collaça"
date: "December 5, 2017"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Six young health participants were asked to perform one set of 10 repetitions of the Unilateral Dumbbell Biceps Curl in five different fashions: exactly according to the specification (Class A), throwing the elbows to the front (Class B), lifting the dumbbell only halfway (Class C), lowering the dumbbell only halfway (Class D) and throwing the hips to the front (Class E).

Read more: http://groupware.les.inf.puc-rio.br/har#weight_lifting_exercises

## Data validation and transformation
```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr); library(tidyr); library(ggplot2); library(GGally); library(RColorBrewer)
source("HAR-WLE-utils.R")
training <- read.csv("pml-training.csv", stringsAsFactors = FALSE)
testing <- read.csv("pml-testing.csv", stringsAsFactors = FALSE)
```

The training set row and columns dimensions
```{r echo=FALSE}
dim(training)
```

The testing set row and columns dimensions
```{r echo=FALSE}
dim(testing)
```

### Total readings by classification and user
```{r echo=FALSE, comment=""}
with(training, rbind(cbind(table(classe, user_name), "(total)" = table(classe)),
                     "(total)" = c(table(user_name), length(user_name))))
```

### Total windows and average readings per user and classe
```{r echo=FALSE}
training %>%
    group_by(user_name, classe, num_window) %>%
        summarise(window_readings=n()) %>%
    group_by(user_name, classe) %>%
        summarise(total_windows=n_distinct(num_window), average_readings=round(mean(window_readings),0)) %>%
    knitr::kable()
```

### Missing values: NA, "#DIV/0!" or ""

100 training variables have either 98% or 100% missing values.
```{r echo=FALSE, comment=""}
trainNAproportion <- sapply(training, missProportion)
table(round(trainNAproportion,2))
```

100 testing variables have 100% missing values.
```{r echo=FALSE, comment=""}
testNAproportion <- sapply(testing, missProportion)
table(testNAproportion)
```

By visually inspecting the dataset it was found the missing values are due to statistics calculated in time windows and stored at rows whose new_window = "yes", characterizing a messy data set where rows are not allways representing a single observation.  As those statistics can be recalculated from the raw data, they will be disregarded.
```{r include=FALSE}
WLEdataCleanup()
```

The new training and test set row and columns dimensions
```{r echo=FALSE}
dim(training); dim(testing)
```
## Exploratory Data Analysis

### [Heatmaps](HAR-WLE-heatmaps.md)

### [Generalized pairs plots](HAR-WLE-ggpairs.md)

### Faceted scatter plots

#### TODO: What are the accelerometer, gyroscope and magnetometer units?
#### TODO: What are the pitch, roll, yaw and total_accel units?

#### All features by sensor set and users
```{r include=FALSE}
prepareFacet <- function(data, groups, features, color, lhsName, lhsPattern, lhsReplacement, rhsName, rhsPattern, rhsReplacement) {
    data %>%
        select(matches(groups), matches(features), matches(color)) %>%
        mutate_at(vars(matches(groups)), factor) %>%
        mutate_at(vars(matches(color)), factor) %>%
        gather(key="feature", value = "value", -matches(groups), -matches(color), factor_key = TRUE) %>%
        mutate(!!lhsName := factor(sub(lhsPattern, lhsReplacement, feature)),
               !!rhsName := factor(sub(rhsPattern, rhsReplacement, feature)),
               feature = NULL) %>%
        group_by_at(vars(matches(groups), lhsName, rhsName)) %>% mutate(index=row_number()) %>% ungroup() %>%
        select(matches(groups), lhsName, rhsName, value, index, matches(color)) # %>% arrange() %>% ???
}
```
```{r allFeatures, echo=FALSE, fig.height=60, fig.width=20, cache=TRUE}
data <- prepareFacet(data = training, #training[training$user_name==levels(training$user_name)[1], ],
                     groups = "user_name",
                     color = "classe",
                     features = "(_arm|_belt|_dumbbell|_forearm)",
                     lhsName = "sensor_set",
                     lhsPattern = "^.+_(arm|belt|dumbbell|forearm)_?.*$",
                     lhsReplacement = "\\1",
                     rhsName = "signal",
                     rhsPattern = "^(.+)_(arm|belt|dumbbell|forearm)(_?)(.*)$",
                     rhsReplacement <- "\\1\\3\\4")
ggplot(data, aes(x=index, y=value, color=classe)) + theme(legend.position = "top") +
    ggtitle("Scatter plots of all features faceted on sensor set and users") +
    facet_grid(sensor_set + user_name ~ signal,
               margins="user_name", scales="free", space="free", shrink=TRUE, switch="y") +
    geom_point(size=.9) + geom_smooth(method="loess", color=1, size=0.7, se=FALSE)
    #geom_smooth(method="lm", color=1, size=0.8, se=FALSE, linetype=2)
```

#### Accelerometer features by sensors and users
```{r accelerometerFeature, echo=FALSE, fig.height=60, fig.width=20, cache=TRUE}
data <- prepareFacet(data = training,#[training$user_name==levels(training$user_name)[1], ],
                     groups = "user_name",
                     color = "classe",
                     features = "^accel.+[xyz]$",
                     lhsName = "sensor_set",
                     lhsPattern = "^.+_(arm|belt|dumbbell|forearm)_?.*$",
                     lhsReplacement = "\\1",
                     rhsName = "signal",
                     rhsPattern = "^(.+)_(arm|belt|dumbbell|forearm)(_?)(.*)$",
                     rhsReplacement <- "\\1\\3\\4")
ggplot(data, aes(x=index, y=value, color=classe)) + theme(legend.position = "top") +
    ggtitle("Scatter plots of Accelerometer features faceted on sensors and users") +
    facet_grid(sensor_set + user_name ~ signal,
               margins="user_name", scales="free", space="free_x", shrink=TRUE, switch="y") +
    geom_point(size=.9) + geom_smooth(method="loess", color=1, size=0.7, se=FALSE)
    #geom_smooth(method="lm", color=1, size=0.8, se=FALSE, linetype=2)
```

#### Gyroscope features by sensors and users
```{r gyroscopeFeature, echo=FALSE, fig.height=60, fig.width=20, cache=TRUE}
data <- prepareFacet(data = training,#[training$user_name==levels(training$user_name)[1], ],
                     groups = "user_name",
                     color = "classe",
                     features = "^gyros.+[xyz]$",
                     lhsName = "sensor_set",
                     lhsPattern = "^.+_(arm|belt|dumbbell|forearm)_?.*$",
                     lhsReplacement = "\\1",
                     rhsName = "signal",
                     rhsPattern = "^(.+)_(arm|belt|dumbbell|forearm)(_?)(.*)$",
                     rhsReplacement <- "\\1\\3\\4")
ggplot(data, aes(x=index, y=value, color=classe)) + theme(legend.position = "top") +
    ggtitle("Scatter plots of gyroscope features faceted on sensors and users") +
    facet_grid(sensor_set + user_name ~ signal,
               margins="user_name", scales="free", space="free_x", shrink=TRUE, switch="y") +
    geom_point(size=.9) + geom_smooth(method="loess", color=1, size=0.7, se=FALSE)
    #geom_smooth(method="lm", color=1, size=0.8, se=FALSE, linetype=2)
```

#### Euler angle features by sensors and users
```{r eulerAngleFeatures, echo=FALSE, fig.height=60, fig.width=20, cache=TRUE}
data <- prepareFacet(data = training,#[training$user_name==levels(training$user_name)[1], ],
                     groups = "user_name",
                     color = "classe",
                     features = "^(pitch|roll|yaw)_(arm|belt|dumbbell|forearm)$",
                     lhsName = "sensor_set",
                     lhsPattern = "^.+_(arm|belt|dumbbell|forearm)_?.*$",
                     lhsReplacement = "\\1",
                     rhsName = "signal",
                     rhsPattern = "^(.+)_(arm|belt|dumbbell|forearm)(_?)(.*)$",
                     rhsReplacement <- "\\1\\3\\4")
ggplot(data, aes(x=index, y=value, color=classe)) + theme(legend.position = "top") +
    ggtitle("Scatter plots of Euler angle features faceted on sensors and users") +
    facet_grid(sensor_set + user_name ~ signal,
               margins="user_name", scales="free", space="free_x", shrink=TRUE, switch="y") +
    geom_point(size=.9) + geom_smooth(method="loess", color=1, size=0.7, se=FALSE)
    #geom_smooth(method="lm", color=1, size=0.8, se=FALSE, linetype=2)
```



















